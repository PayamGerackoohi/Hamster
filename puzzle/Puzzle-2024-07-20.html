<!DOCTYPE html>
<html>
<meta charset="UTF-8">

<head>
  <style>
    #box {
      border: 1px solid black;
      background-color: white;
    }

    .controller {
      display: flex;
      width: 602px;
    }

    #previous,
    #next {
      font-size: 5em;
      flex-grow: 1;
      height: 2em;
      color: white;
    }

    #previous[disabled],
    #next[disabled] {
      background-color: gray;
    }

    #previous {
      background-color: red;
    }

    #next {
      background-color: green;
    }
  </style>
</head>

<body>
  <canvas id="box" width="600" height="600"></canvas>
  <div class="controller">
    <button id="previous" onclick="onPreviousClicked()">&lt;</button>
    <button id="next" onclick="onNextClicked()">&gt;</button>
  </div>
  <script>
    const boxEl = document.getElementById("box")
    const canvas = boxEl.getContext("2d")
    const previousEl = document.getElementById("previous")
    const nextEl = document.getElementById("next")
    let blocks = [
      {
        p: [1, 0],
        h: 1,
        v: 2,
      },
      {
        p: [2, 1],
        h: 2,
        v: 1,
      },
      {
        p: [4, 0],
        h: 1,
        v: 3,
      },
      {
        p: [5, 0],
        h: 1,
        v: 2,
      },
      {
        p: [2, 2],
        h: 1,
        v: 2,
      },
      {
        p: [3, 3],
        h: 2,
        v: 1,
      },
      {
        p: [0, 3],
        h: 1,
        v: 3,
      },
      {
        p: [1, 4],
        h: 2,
        v: 1,
      },
      {
        p: [1, 5],
        h: 2,
        v: 1,
      },
      {
        p: [3, 4],
        h: 1,
        v: 2,
      },
      {
        p: [4, 5],
        h: 2,
        v: 1,
      },
    ]
    let key = {
      p: [0, 2],
      h: 2,
      v: 1,
    }
    const operations = [
      { b: 5, h: 1 },
      { b: 9, v: -2 },
      { b: 7, h: 3 },
      { b: 4, v: 1 },
      { b: 9, v: 2 },
      { h: 2 },
      { b: 0, v: 3 },
      { h: -2 },
      { b: 1, h: -2 },
      { b: 4, v: -3 },
      { b: 9, v: -4 },
      { h: 2 },
      { b: 6, v: -1 },
      { b: 0, v: -1 },
      { b: 8, h: -1 },
      { b: 5, h: -2 },
      { b: 7, h: -3 },
      { b: 10, h: -2 },
      { b: 2, v: 3 },
      { b: 3, v: 3 },
      { h: 2 },
    ]
    const guides = [
      [5, 3, 1, 0, 1],
      [3, 2, 0, 2, -1],
      [3, 4, 3, 0, 1],
      [2, 4, 0, 1, 1],
      [3, 4, 0, 2, 1],
      [2, 2, 2, 0, 1],
      [1, 2, 0, 3, 1],
      [0, 2, 2, 0, -1],
      [0, 1, 2, 0, -1],
      [2, 0, 0, 3, -1],
      [3, 0, 0, 4, -1],
      [2, 2, 2, 0, 1],
      [0, 2, 0, 1, -1],
      [1, 2, 0, 1, -1],
      [0, 5, 1, 0, -1],
      [2, 3, 2, 0, -1],
      [1, 4, 3, 0, -1],
      [2, 5, 2, 0, -1],
      [4, 3, 0, 3, 1],
      [5, 2, 0, 3, 1],
      [4, 2, 2, 0, 1],
    ]
    let step = 0
    draw()
    function onPreviousClicked() {
      step -= 1
      if (step < 0)
        step = 0
      else {
        previousOperation()
        draw()
      }
    }
    function onNextClicked() {
      step += 1
      if (step > operations.length)
        step = operations.length
      else {
        nextOperation()
        draw()
      }
    }
    function previousOperation() {
      const operation = inverseOperation(operations[step])
      applyOperation(operation)
    }
    function nextOperation() {
      applyOperation(operations[step - 1])
    }
    function applyOperation(operation) {
      const block = operation.b === undefined ? key : blocks[operation.b]
      if (operation.h) block.p[0] += operation.h
      if (operation.v) block.p[1] += operation.v
    }
    function inverseOperation(operation) {
      return { ...operation, h: -operation.h, v: -operation.v }
    }
    function draw() {
      checkControllerState()
      clearCanvas()
      drawBlocks()
      drawGuides()
      drawKey()
    }
    function disableIf(element, condition) {
      condition ?
        element.setAttribute('disabled', '') :
        element.removeAttribute('disabled')
    }
    function checkControllerState() {
      disableIf(previousEl, step === 0)
      disableIf(nextEl, step === operations.length)
    }
    function clearCanvas() {
      canvas.clearRect(0, 0, boxEl.width, boxEl.height)
    }
    function toCanvasCoord(block) {
      const scale = 100
      return [
        block.p[0] * scale,
        block.p[1] * scale,
        block.h * scale,
        block.v * scale,
      ]
    }
    function textCoord(text, x, y, h, v) {
      return [
        x + h / 2 - ((text.length > 1) ? 20 : 10),
        y + v / 2 + 15,
      ]
    }
    function drawKey() {
      canvas.beginPath()
      const [x, y, h, v] = toCanvasCoord(key)
      canvas.fillStyle = 'yellow'
      canvas.fillRect(x, y, h, v)
      canvas.rect(x, y, h, v)
      canvas.stroke()
    }
    function drawBlocks() {
      canvas.beginPath()
      let index = 0
      blocks.forEach(block => {
        const [x, y, h, v] = toCanvasCoord(block)
        canvas.fillStyle = (v > h) ? 'red' : 'green'
        canvas.fillRect(x, y, h, v)

        canvas.rect(x, y, h, v)

        const i = index.toString()
        const [tx, ty] = textCoord(i, x, y, h, v)
        canvas.font = '3em Arial'
        canvas.fillStyle = 'black'
        canvas.fillText(i, tx, ty)

        index += 1
      })
      canvas.stroke()
    }
    function drawGuides() {
      const guide = guides[step]
      if (!guide)
        return
      const x = guide[0]
      const y = guide[1]
      const h = guide[2]
      const v = guide[3]
      const p = guide[4]
      canvas.beginPath()
      if (h !== 0) {
        const text = p === 1 ? '>' : '<'
        for (let i = 0; i < h; i += 1)
          drawGuide(x + i, y, text)
      }
      if (v !== 0) {
        const text = p === 1 ? '˅' : '˄'
        for (let i = 0; i < v; i += 1)
          drawGuide(x, y + i, text)
      }
      canvas.stroke()
    }
    function drawGuide(xx, yy, text) {
      const [x, y, h, v] = toCanvasCoord({ p: [xx, yy], h: 1, v: 1 })
      canvas.fillStyle = 'lightgray'
      canvas.fillRect(x, y, h, v)

      const [tx, ty] = textCoord(text, x, y, h, v)
      canvas.font = '3em Arial'
      canvas.fillStyle = 'yellow'
      canvas.fillText(text, tx, ty)
    }
  </script>
</body>

</html>