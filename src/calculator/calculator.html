<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Calculator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="css/common.css" rel="stylesheet">
  <link href="css/calculator.css" rel="stylesheet">
  <script src="js/nav.js" defer></script>
</head>

<body>
  <div id="nav" page="Calculator"></div>
  <div id="content">
    <noscript>You need to enable JavaScript to run this app.
      <h1>How?</h1>
      <h4>iPhone + Safari:</h4>
      <li>Go into the Settings app</li>
      <li>Click "Safari"</li>
      <li>Click "Advanced"</li>
      <li>Swipe the JavaScript button to the right so it appears green.</li>
      <h1>Not working?</h1>
      <h4>Try:</h4>
      <li>iPhone + Chrome</li>
    </noscript>
    <div id="root"></div>
    <div id="temp" class="hide"></div>
  </div>
  <script>
    const rootEl = document.getElementById('root')
    const tempEl = document.getElementById('temp')
    let version = 1
    let status = {
      balance: 0,
      level: 0,
      earnPerHour: 0,
      target: 0,
      benefitThreshold: function () {
        return this.earnPerHour / this.remainedCash()
      },
      expectedTargetReachTime: function () {
        if (this.earnPerHour)
          return formatTime(this.remainedCash() / this.earnPerHour)
        else
          null
      },
      remainedCash: function () {
        return this.target - this.balance
      },
    }
    const groups = [
      'PR & Team',
      'Markets',
      'Legal',
      'Web3',
      'Specials',
      'Other',
    ]
    let upgrades = []
    let currentUpgrade = null
    const EditMode = {
      None: 'None',
      Balance: 'Balance',
      Level: 'Level',
      EarnPerHour: 'EarnPerHour',
      Target: 'Target',
    }
    let editMode = EditMode.None

    realtimeEarn()
    drawContent()

    function realtimeEarn() {
      status.balance += Math.floor(status.earnPerHour / 3600)
      setTimeout(realtimeEarn, 1000)
    }
    function drawContent() {
      rootEl.innerHTML = ''
      ActionBarEl()
      ItemAdditionEl(onUpgradeAdded, clearCurrentUpgrade, removeUpgrade)
      CurrentStatusEl(
        onBalanceEdit, onConfirmBalance, closeBalanceEdit,
        onLevelEdit, onConfirmLevel, closeLevelEdit,
        onEPHEdit, onConfirmEPH, closeEPHEdit,
        onTargetEdit, onConfirmTarget, onCloseTargetEdit,
      )
      UpgradeListEl(onUpgradeSelected)
    }
    async function readFile(event) {
      const file = event.target.files.item(0)
      const text = await file.text()
      const data = JSON.parse(text)
      version = data.version + 1
      Object.assign(status, data.status)
      upgrades = toImportFormat(data)
      drawContent()
    }
    function ActionBarEl() {
      const containerEl = rootEl.appendChild(document.createElement('div'))
      containerEl.className = 'action-bar'
      ImportButtonEl(containerEl)
      ExportButtonEl(containerEl)
      RefreshButtonEl(containerEl, drawContent)
      TargetReachTime(containerEl)

      function ImportButtonEl(parentEl) {
        const buttonEl = parentEl.appendChild(document.createElement('button'))
        buttonEl.textContent = 'Import'
        buttonEl.className = 'normal-button-padding'
        const importFileEl = ImportFileEl()
        buttonEl.onclick = () => importFileEl.click()

        function ImportFileEl() {
          tempEl.innerHTML = ''
          const inputEl = tempEl.appendChild(document.createElement('input'))
          inputEl.type = 'file'
          inputEl.onchange = (event) => readFile(event)
          return inputEl
        }
      }
      function ExportButtonEl(parentEl) {
        const buttonEl = parentEl.appendChild(document.createElement('button'))
        buttonEl.textContent = 'Export'
        buttonEl.className = 'normal-button-padding'
        buttonEl.onclick = () => {
          upgrades.sort((a, b) => a.group.localeCompare(b.group) || a.title.localeCompare(b.title))
          ExportFileEl({ version, status, upgrades: toExportFormat(upgrades) })

          function ExportFileEl(data) {
            tempEl.innerHTML = ''
            const aEl = tempEl.appendChild(document.createElement('a'))
            aEl.download = 'Hamster.json'
            const blob = new Blob([JSON.stringify(data, null, 2)])
            aEl.href = window.URL.createObjectURL(blob)
            aEl.click()
          }
        }
      }
      function RefreshButtonEl(parentEl, onClick) {
        const buttonEl = parentEl.appendChild(document.createElement('button'))
        buttonEl.textContent = 'Refresh'
        buttonEl.className = 'normal-button-padding'
        buttonEl.onclick = onClick
      }
      function TargetReachTime(parentEl) {
        const pEl = parentEl.appendChild(document.createElement('p'))
        pEl.className = 'reach-time'
        const expectedTargetReachTime = status.expectedTargetReachTime()
        let text = ''
        if (expectedTargetReachTime)
          text = `Target Reach Time: ${expectedTargetReachTime}`
        pEl.textContent = text
      }
    }
    function ItemAdditionEl(onUpgradeAdded, onClearClicked, onRemoveClicked) {
      const settingsEl = rootEl.appendChild(document.createElement('div'))
      settingsEl.id = 'settings'
      AdditionFormEl(settingsEl, onUpgradeAdded, onClearClicked, onRemoveClicked)

      function AdditionFormEl(parentEl, onItemAdded, onClearClicked, onRemoveClicked) {
        const formEl = parentEl.appendChild(document.createElement('div'))
        formEl.className = 'add-group-form'
        const groupEl = GroupEl(formEl)
        const titleEl = TitleEl(formEl)
        const levelEl = LevelEl(formEl)
        const valueEl = ValueEl(formEl)
        const costEl = CostEl(formEl)
        AddButtonEl(formEl, onAddClicked)
        ClearButtonEl(formEl, onClearClicked)
        currentUpgrade && RemoveButtonEl(formEl, onRemoveClicked)

        function onAddClicked() {
          const item = {
            group: groupEl.value,
            title: titleEl.value,
            value: +valueEl.value,
            cost: +costEl.value,
            level: +levelEl.value,
          }
          const isSane = checkUpgradeItemSanity(item)
          isSane && onItemAdded(item)
        }
        function GroupEl(parentEl) {
          const selectEl = parentEl.appendChild(document.createElement('select'))
          selectEl.setAttribute('name', 'group')
          selectEl.className = 'centered-text'
          GroupOptionEl(selectEl)
          OptionsEl(selectEl)
          if (currentUpgrade)
            selectEl.value = currentUpgrade.group

          function GroupOptionEl(parentEl) {
            const optionEl = parentEl.appendChild(document.createElement('option'))
            optionEl.setAttribute('value', null)
            optionEl.textContent = '-- Select Group --'
          }
          function OptionsEl(parentEl) {
            groups.forEach(group => {
              const optionEl = parentEl.appendChild(document.createElement('option'))
              optionEl.setAttribute('value', group)
              optionEl.textContent = group
            })
          }
          return selectEl
        }
        function TitleEl(parentEl) {
          const inputEl = parentEl.appendChild(document.createElement('input'))
          inputEl.setAttribute('type', 'text')
          inputEl.setAttribute('name', 'title')
          inputEl.setAttribute('placeholder', 'Title')
          if (currentUpgrade)
            inputEl.value = currentUpgrade.title
          return inputEl
        }
        function ValueEl(parentEl) {
          const inputEl = parentEl.appendChild(document.createElement('input'))
          inputEl.setAttribute('type', 'number')
          inputEl.setAttribute('name', 'value')
          inputEl.setAttribute('placeholder', 'Value')
          if (currentUpgrade)
            inputEl.value = currentUpgrade.value
          return inputEl
        }
        function CostEl(parentEl) {
          const inputEl = parentEl.appendChild(document.createElement('input'))
          inputEl.setAttribute('type', 'number')
          inputEl.setAttribute('name', 'cost')
          inputEl.setAttribute('placeholder', 'Cost')
          if (currentUpgrade)
            inputEl.value = currentUpgrade.cost
          return inputEl
        }
        function LevelEl(parentEl) {
          const inputEl = parentEl.appendChild(document.createElement('input'))
          inputEl.setAttribute('type', 'number')
          inputEl.setAttribute('name', 'level')
          inputEl.setAttribute('placeholder', 'Level')
          if (currentUpgrade)
            inputEl.value = currentUpgrade.level
          return inputEl
        }
        function AddButtonEl(parentEl, onClick) {
          const buttonEl = parentEl.appendChild(document.createElement('button'))
          buttonEl.className = 'positive-button'
          buttonEl.textContent = 'Add'
          buttonEl.onclick = onClick
        }
        function ClearButtonEl(parentEl, onClick) {
          const buttonEl = parentEl.appendChild(document.createElement('button'))
          buttonEl.className = 'negative-button'
          buttonEl.textContent = 'Clear'
          buttonEl.onclick = onClick
        }
        function RemoveButtonEl(parentEl, onClick) {
          const buttonEl = parentEl.appendChild(document.createElement('button'))
          buttonEl.className = 'negative-button'
          buttonEl.textContent = 'Remove'
          buttonEl.onclick = onClick
        }
      }
    }
    function CurrentStatusEl(
      onBalanceEdit, onConfirmBalance, onCancelBalanceEdit,
      onLevelEdit, onConfirmLevel, onCancelLevelEdit,
      onEPHEdit, onConfirmEPH, onCancelEPHEdit,
      onTargetEdit, onConfirmTarget, onCancelTargetEdit,
    ) {
      const tableEl = rootEl.appendChild(document.createElement('table'))
      tableEl.className = 'current-status'
      HeaderEl(tableEl)
      ContentEl(
        tableEl, status,
        onBalanceEdit, onConfirmBalance, onCancelBalanceEdit,
        onLevelEdit, onConfirmLevel, onCancelLevelEdit,
        onEPHEdit, onConfirmEPH, onCancelEPHEdit,
        onTargetEdit, onConfirmTarget, onCancelTargetEdit,
      )
      function HeaderEl(parentEl) {
        const theadEl = parentEl.appendChild(document.createElement('thead'))
        if (editModeIsNoneOr(EditMode.Balance)) TdElWithText(theadEl, 'Balance')
        if (editModeIsNoneOr(EditMode.Level)) TdElWithText(theadEl, 'Level')
        if (editModeIsNoneOr(EditMode.EarnPerHour)) TdElWithText(theadEl, 'Earn / Hour')
        if (editModeIsNoneOr(EditMode.Target)) TdElWithText(theadEl, 'Target')
      }
      function ContentEl(
        parentEl, { balance, level, earnPerHour, target },
        onBalanceEdit, onConfirmBalance, onCancelBalanceEdit,
        onLevelEdit, onConfirmLevel, onCancelLevelEdit,
        onEPHEdit, onConfirmEPH, onCancelEPHEdit,
        onTargetEdit, onConfirmTarget, onCancelTargetEdit,
      ) {
        const tbodyEl = parentEl.appendChild(document.createElement('tbody'))
        const rowEl = tbodyEl.appendChild(document.createElement('tr'))
        BalanceEl(rowEl, balance, onBalanceEdit, onConfirmBalance, onCancelBalanceEdit)
        LevelEl(rowEl, level, onLevelEdit, onConfirmLevel, onCancelLevelEdit)
        EarnPerHourEl(rowEl, earnPerHour, onEPHEdit, onConfirmEPH, onCancelEPHEdit)
        TargetEl(rowEl, target, onTargetEdit, onConfirmTarget, onCancelTargetEdit)

        function BalanceEl(parentEl, balance, onEdit, onConfirm, onCancel) {
          if (editMode === EditMode.Balance) {
            const tdEl = TdEl(parentEl)
            tdEl.className = 'no-padding'
            EditableNumberInputEl(tdEl, "balance", balance, onConfirm, onCancel)
          } else if (editMode === EditMode.None) {
            const tdEl = TdElWithText(parentEl, `${balance.toLocaleString()} $`)
            tdEl.onclick = onEdit
          }
        }
        function LevelEl(parentEl, level, onEdit, onConfirm, onCancel) {
          if (editMode === EditMode.Level) {
            const tdEl = TdEl(parentEl)
            tdEl.className = 'no-padding'
            EditableNumberInputEl(tdEl, "level", level, onConfirm, onCancel)
          } else if (editMode === EditMode.None) {
            const tdEl = TdElWithText(parentEl, level)
            tdEl.onclick = onEdit
          }
        }
        function EarnPerHourEl(parentEl, earnPerHour, onEdit, onConfirm, onCancel) {
          if (editMode === EditMode.EarnPerHour) {
            const tdEl = TdEl(parentEl)
            tdEl.className = 'no-padding'
            EditableNumberInputEl(tdEl, 'earn-per-hour', earnPerHour, onConfirm, onCancel)
          } else if (editMode === EditMode.None) {
            const tdEl = TdElWithText(parentEl, `${earnPerHour.toLocaleString()} $`)
            tdEl.onclick = onEdit
          }
        }
        function TargetEl(parentEl, target, onEdit, onConfirm, onCancel) {
          if (editMode === EditMode.Target) {
            const tdEl = TdEl(parentEl)
            tdEl.className = 'no-padding'
            EditableNumberInputEl(tdEl, 'target', target, onConfirm, onCancel)
          } else if (editMode === EditMode.None) {
            const tdEl = TdElWithText(parentEl, `${target.toLocaleString()} $`)
            tdEl.onclick = onEdit
          }
        }
        function EditableNumberInputEl(parentEl, label, balance, onConfirm, onCancel) {
          const containerEl = parentEl.appendChild(document.createElement('div'))
          containerEl.className = 'flex-row'
          let inputEl
          CancelButtonEl(containerEl, onCancel)
          inputEl = NumberInputEl(containerEl, label, balance)
          ConfirmButtonEl(containerEl, () => onConfirm(inputEl.value))

          function NumberInputEl(parentEl, label, value) {
            const inputEl = parentEl.appendChild(document.createElement('input'))
            inputEl.type = 'number'
            inputEl.classList.add('centered-text', 'extend')
            inputEl.value = value
            inputEl.name = label
            return inputEl
          }
          function ConfirmButtonEl(parentEl, onClick) {
            const buttonEl = parentEl.appendChild(document.createElement('button'))
            buttonEl.textContent = 'Confirm'
            buttonEl.classList.add('positive-button', 'normal-button-padding')
            buttonEl.onclick = onClick
          }
          function CancelButtonEl(parentEl, onClick) {
            const buttonEl = parentEl.appendChild(document.createElement('button'))
            buttonEl.textContent = 'Cancel'
            buttonEl.classList.add('negative-button', 'normal-button-padding')
            buttonEl.onclick = onClick
          }
        }
      }
    }
    function UpgradeListEl(onItemClicked) {
      const tableEl = rootEl.appendChild(document.createElement('table'))
      tableEl.className = 'content'
      HeaderEl(tableEl)
      ContentEl(tableEl, onItemClicked)

      function HeaderEl(parentEl) {
        const theadEl = parentEl.appendChild(document.createElement('thead'))
        TdElWithText(theadEl, 'Group')
        TdElWithText(theadEl, 'Title')
        TdElWithText(theadEl, 'Level')
        TdElWithText(theadEl, 'Value ($)')
        TdElWithText(theadEl, 'Cost ($)')
        TdElWithText(theadEl, 'Benefit (%)')
      }

      function ContentEl(parentEl, onItemClicked) {
        const tbodyEl = parentEl.appendChild(document.createElement('tbody'))
        const benefitThreshold = status.benefitThreshold()
        upgrades.filter(it => it.cost < status.balance)
          .map(it => ({ ...it, benefit: it.value / it.cost }))
          .sort((a, b) => b.benefit - a.benefit)
          .forEach(item => {
            const rowEl = tbodyEl.appendChild(document.createElement('tr'))
            currentUpgrade && (item.title === currentUpgrade.title) && rowEl.setAttribute('selected', '')
            rowEl.onclick = () => onItemClicked(item)
            GroupEl(rowEl, item.group)
            TitleEl(rowEl, item.title)
            LevelEl(rowEl, item.level)
            ValueEl(rowEl, item.value)
            CostEl(rowEl, item.cost)
            BenefitEl(rowEl, item.benefit)

            function TableDataEl(parentEl) {
              return parentEl.appendChild(document.createElement('td'))
            }
            function TableDataWithTextEl(parentEl, text) {
              const el = TableDataEl(parentEl)
              el.textContent = text
              return el
            }
            function GroupEl(parentEl, group) {
              TableDataWithTextEl(parentEl, group)
            }
            function TitleEl(parentEl, title) {
              TableDataWithTextEl(parentEl, title)
            }
            function ValueEl(parentEl, value) {
              const valueEl = TableDataWithTextEl(parentEl, value.toLocaleString())
              valueEl.className = 'centered-text'
            }
            function CostEl(parentEl, cost) {
              const costEl = TableDataWithTextEl(parentEl, cost.toLocaleString())
              costEl.className = 'centered-text'
            }
            function LevelEl(parentEl, level) {
              const levelEl = TableDataWithTextEl(parentEl, level)
              levelEl.className = 'centered-text'
            }
            function BenefitEl(parentEl, benefit) {
              const el = TableDataWithTextEl(parentEl, (100 * benefit).toPrecision(4))
              if (benefit < benefitThreshold)
                el.classList.add('red-text')
              el.classList.add('centered-text')
            }
          })
      }
    }
    function onUpgradeAdded(upgrade) {
      const index = upgrades.findIndex(it => it.title === upgrade.title)
      if (index === -1)
        upgrades.push(upgrade)
      else {
        status.balance -= upgrades[index].cost
        upgrade.level += 1
        upgrades[index] = upgrade
      }
      currentUpgrade = upgrade
      drawContent()
    }
    function checkUpgradeItemSanity({ group, title, value, cost, level }) {
      const cases = [
        {
          title: 'Group',
          value: group,
          evaluator: isGroupInvalid,
        },
        {
          title: 'Title',
          value: title,
          evaluator: isTitleInvalid,
        },
        {
          title: 'Value',
          value: value,
          evaluator: isIntegerInvalid,
        },
        {
          title: 'Cost',
          value: cost,
          evaluator: isIntegerInvalid,
        },
        {
          title: 'Level',
          value: level,
          evaluator: isLevelInvalid,
        },
      ]
      for (let c of cases) {
        if (c.evaluator(c.value)) {
          alert(`Invalid ${c.title}: "${c.value}"`)
          return false
        }
      }

      function isGroupInvalid(group) {
        return group === 'null'
      }
      function isTitleInvalid(title) {
        return title === ''
      }
      function isIntegerInvalid(value) {
        return value <= 0
      }
      function isLevelInvalid(value) {
        return value < 0
      }

      return true
    }
    function onUpgradeSelected(upgrade) {
      currentUpgrade = { ...upgrade, value: '', cost: '' }
      drawContent()
    }
    function clearCurrentUpgrade() {
      currentUpgrade = null
      drawContent()
    }
    function removeUpgrade() {
      if (currentUpgrade !== null) {
        const index = upgrades.findIndex(it => it.title === currentUpgrade.title)
        if (index !== -1)
          upgrades.splice(index, 1)
      }
      currentUpgrade = null
      drawContent()
    }
    function onBalanceEdit() {
      editMode = EditMode.Balance
      drawContent()
    }
    function onConfirmBalance(balance) {
      status.balance = +balance
      closeBalanceEdit()
    }
    function closeBalanceEdit() {
      editMode = EditMode.None
      drawContent()
    }
    function onLevelEdit() {
      editMode = EditMode.Level
      drawContent()
    }
    function onConfirmLevel(level) {
      status.level = level
      closeLevelEdit()
    }
    function closeLevelEdit() {
      editMode = EditMode.None
      drawContent()
    }
    function onEPHEdit() {
      editMode = EditMode.EarnPerHour
      drawContent()
    }
    function onConfirmEPH(earnPerHour) {
      status.earnPerHour = +earnPerHour
      closeEPHEdit()
    }
    function closeEPHEdit() {
      editMode = EditMode.None
      drawContent()
    }
    function onTargetEdit() {
      editMode = EditMode.Target
      drawContent()
    }
    function onConfirmTarget(target) {
      status.target = +target
      onCloseTargetEdit()
    }
    function onCloseTargetEdit() {
      editMode = EditMode.None
      drawContent()
    }
    function formatTime(time) {
      const result = []
      if (time === 0) return '0h'
      if (!time) return ''
      if (time > 24) {
        const d = Math.floor(time / 24)
        time -= 24 * d
        result.push(`${d}d`)
      }
      time && result.push(`${Math.floor(time)}h`)
      return result.join(' ')
    }
    function editModeIsNoneOr(mode) {
      return editMode === EditMode.None || editMode === mode
    }
    function TdEl(parentEl) {
      return parentEl.appendChild(document.createElement('td'))
    }
    function TdElWithText(parentEl, text) {
      const tdEl = parentEl.appendChild(document.createElement('td'))
      tdEl.textContent = text
      return tdEl
    }
    function toExportFormat(upgrades) {
      let result = {}
      upgrades.forEach(it => {
        if (!(it.group in result))
          result[it.group] = []
        const { group, ...data } = it
        result[it.group].push(data)
      })
      return result
    }
    function toImportFormat({ version, upgrades }) {
      let result = []
      for (group in upgrades)
        upgrades[group].forEach(it => result.push({ group, ...it }))
      return result
    }
  </script>
</body>

</html>