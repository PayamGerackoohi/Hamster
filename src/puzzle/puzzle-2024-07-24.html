<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Puzzle</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="css/common.css" rel="stylesheet">
  <link href="css/puzzle.css" rel="stylesheet">
  <script src="js/nav.js" defer></script>
</head>

<body>
  <div id="nav" page="Puzzle"></div>
  <div id="content">
    <div id="canvas-holder">
      <canvas id="canvas" width="600" height="600"></canvas>
    </div>
    <div class="controller">
      <button id="previous" onclick="onPreviousClicked()">&lt;</button>
      <p id="steps"></p>
      <button id="next" onclick="onNextClicked()">&gt;</button>
    </div>
  </div>
  <script>
    const canvasEl = document.getElementById("canvas")
    const canvas = canvasEl.getContext("2d")
    const previousEl = document.getElementById("previous")
    const nextEl = document.getElementById("next")
    const stepsEl = document.getElementById("steps")
    let blocks = [
      {
        p: [1, 0],
        h: 1,
        v: 2,
      },
      {
        p: [4, 0],
        h: 2,
        v: 1,
      },
      {
        p: [2, 1],
        h: 2,
        v: 1,
      },
      {
        p: [4, 1],
        h: 1,
        v: 2,
      },
      {
        p: [2, 2],
        h: 1,
        v: 2,
      },
      {
        p: [0, 3],
        h: 2,
        v: 1,
      },
      {
        p: [3, 3],
        h: 2,
        v: 1,
      },
      {
        p: [5, 3],
        h: 1,
        v: 3,
      },
      {
        p: [0, 4],
        h: 1,
        v: 2,
      },
      {
        p: [1, 4],
        h: 2,
        v: 1,
      },
      {
        p: [3, 4],
        h: 1,
        v: 2,
      },
    ]
    let key = {
      p: [0, 2],
      h: 2,
      v: 1,
    }
    const operations = [
      { b: 1, h: -2 },
      { b: 7, v: -3 },
      { b: 6, h: 1 },
      { b: 10, v: -2 },
      { b: 9, h: 3 },
      { b: 4, v: 2 },
      { h: 1 },
      { b: 5, h: 1 },
      { b: 8, v: -4 },
      { h: -1 },
      { b: 5, h: -1 },
      { b: 4, v: -2 },
      { b: 9, h: -4 },
      { b: 4, v: 2 },
      { b: 10, v: 2 },
      { b: 6, h: -2 },
      { b: 3, v: -1 },
      { b: 7, v: 3 },
      { h: 4 },
    ]
    const guides = [
      [2, 0, 2, 0, -1],
      [5, 0, 0, 3, -1],
      [5, 3, 1, 0, 1],
      [3, 2, 0, 2, -1],
      [3, 4, 3, 0, 1],
      [2, 4, 0, 2, 1],
      [2, 2, 1, 0, 1],
      [2, 3, 1, 0, 1],
      [0, 0, 0, 4, -1],
      [0, 2, 1, 0, -1],
      [0, 3, 1, 0, -1],
      [2, 2, 0, 2, -1],
      [0, 4, 4, 0, -1],
      [2, 4, 0, 2, 1],
      [3, 4, 0, 2, 1],
      [2, 3, 2, 0, -1],
      [4, 0, 0, 1, -1],
      [5, 3, 0, 3, 1],
      [2, 2, 4, 0, 1],
    ]
    let step = 0
    const blockSize = 600 / 6
    updateSteps()
    draw()
    function onPreviousClicked() {
      step -= 1
      if (step < 0)
        step = 0
      else {
        previousOperation()
        draw()
      }
    }
    function onNextClicked() {
      step += 1
      if (step > operations.length)
        step = operations.length
      else {
        nextOperation()
        draw()
      }
    }
    function previousOperation() {
      const operation = inverseOperation(operations[step])
      applyOperation(operation)
      updateSteps()
    }
    function nextOperation() {
      applyOperation(operations[step - 1])
      updateSteps()
    }
    function updateSteps() {
      stepsEl.textContent = `${step}/${operations.length}`
    }
    function applyOperation(operation) {
      const block = operation.b === undefined ? key : blocks[operation.b]
      if (operation.h) block.p[0] += operation.h
      if (operation.v) block.p[1] += operation.v
    }
    function inverseOperation(operation) {
      return { ...operation, h: -operation.h, v: -operation.v }
    }
    function draw() {
      checkControllerState()
      clearCanvas()
      drawBlocks()
      drawGuides()
      drawKey()
    }
    function disableIf(element, condition) {
      condition ?
        element.setAttribute('disabled', '') :
        element.removeAttribute('disabled')
    }
    function checkControllerState() {
      disableIf(previousEl, step === 0)
      disableIf(nextEl, step === operations.length)
    }
    function clearCanvas() {
      canvas.clearRect(0, 0, canvasEl.width, canvasEl.height)
    }
    function toCanvasCoord(block) {
      return [
        block.p[0] * blockSize,
        block.p[1] * blockSize,
        block.h * blockSize,
        block.v * blockSize,
      ]
    }
    function textCoord(text, x, y, h, v) {
      return [
        x + h / 2 - ((text.length > 1) ? 25 : 10),
        y + v / 2 + 15,
      ]
    }
    function drawKey() {
      canvas.beginPath()
      const [x, y, h, v] = toCanvasCoord(key)
      canvas.fillStyle = 'yellow'
      canvas.fillRect(x, y, h, v)
      canvas.rect(x, y, h, v)
      canvas.stroke()
    }
    function drawBlocks() {
      canvas.beginPath()
      let index = 0
      blocks.forEach(block => {
        const [x, y, h, v] = toCanvasCoord(block)
        canvas.fillStyle = (v > h) ? 'red' : 'green'
        canvas.fillRect(x, y, h, v)

        canvas.rect(x, y, h, v)

        const i = index.toString()
        const [tx, ty] = textCoord(i, x, y, h, v)
        canvas.font = '3em Arial'
        canvas.fillStyle = 'black'
        canvas.fillText(i, tx, ty)

        index += 1
      })
      canvas.stroke()
    }
    function drawGuides() {
      const guide = guides[step]
      if (!guide)
        return
      const x = guide[0]
      const y = guide[1]
      const h = guide[2]
      const v = guide[3]
      const p = guide[4]
      canvas.beginPath()
      if (h !== 0) {
        const text = p === 1 ? '>' : '<'
        for (let i = 0; i < h; i += 1)
          drawGuide(x + i, y, text)
      }
      if (v !== 0) {
        const text = p === 1 ? '˅' : '˄'
        for (let i = 0; i < v; i += 1)
          drawGuide(x, y + i, text)
      }
      canvas.stroke()
    }
    function drawGuide(xx, yy, text) {
      const [x, y, h, v] = toCanvasCoord({ p: [xx, yy], h: 1, v: 1 })
      canvas.fillStyle = 'lightgray'
      canvas.fillRect(x, y, h, v)

      const [tx, ty] = textCoord(text, x, y, h, v)
      canvas.font = '3em Arial'
      canvas.fillStyle = 'yellow'
      canvas.fillText(text, tx, ty)
    }
  </script>
</body>

</html>